{"version":3,"sources":["queue.js"],"names":[],"mappings":"AAAA;;AAEA,OAAO,cAAP,CAAsB,OAAtB,EAA+B,YAA/B,EAA6C;AACzC,WAAO;AADkC,CAA7C;AAGA,QAAQ,OAAR,GAAkB,KAAlB;;AAEA,IAAI,eAAe,QAAQ,qBAAR,CAAnB;;AAEA,IAAI,gBAAgB,uBAAuB,YAAvB,CAApB;;AAEA,IAAI,WAAW,QAAQ,gBAAR,CAAf;;AAEA,IAAI,YAAY,uBAAuB,QAAvB,CAAhB;;AAEA,IAAI,QAAQ,QAAQ,aAAR,CAAZ;;AAEA,IAAI,SAAS,uBAAuB,KAAvB,CAAb;;AAEA,IAAI,QAAQ,QAAQ,QAAR,CAAZ;;AAEA,IAAI,SAAS,uBAAuB,KAAvB,CAAb;;AAEA,IAAI,YAAY,QAAQ,YAAR,CAAhB;;AAEA,IAAI,aAAa,uBAAuB,SAAvB,CAAjB;;AAEA,IAAI,gBAAgB,QAAQ,gBAAR,CAApB;;AAEA,IAAI,iBAAiB,uBAAuB,aAAvB,CAArB;;AAEA,IAAI,oBAAoB,QAAQ,oBAAR,CAAxB;;AAEA,IAAI,qBAAqB,uBAAuB,iBAAvB,CAAzB;;AAEA,SAAS,sBAAT,CAAgC,GAAhC,EAAqC;AAAE,WAAO,OAAO,IAAI,UAAX,GAAwB,GAAxB,GAA8B,EAAE,SAAS,GAAX,EAArC;AAAwD;;AAE/F,SAAS,KAAT,CAAe,MAAf,EAAuB,WAAvB,EAAoC,OAApC,EAA6C;AACzC,QAAI,eAAe,IAAnB,EAAyB;AACrB,sBAAc,CAAd;AACH,KAFD,MAEO,IAAI,gBAAgB,CAApB,EAAuB;AAC1B,cAAM,IAAI,KAAJ,CAAU,8BAAV,CAAN;AACH;;AAED,aAAS,OAAT,CAAiB,IAAjB,EAAuB,aAAvB,EAAsC,QAAtC,EAAgD;AAC5C,YAAI,YAAY,IAAZ,IAAoB,OAAO,QAAP,KAAoB,UAA5C,EAAwD;AACpD,kBAAM,IAAI,KAAJ,CAAU,kCAAV,CAAN;AACH;AACD,UAAE,OAAF,GAAY,IAAZ;AACA,YAAI,CAAC,CAAC,GAAG,UAAU,OAAd,EAAuB,IAAvB,CAAL,EAAmC;AAC/B,mBAAO,CAAC,IAAD,CAAP;AACH;AACD,YAAI,KAAK,MAAL,KAAgB,CAAhB,IAAqB,EAAE,IAAF,EAAzB,EAAmC;AAC/B;AACA,mBAAO,CAAC,GAAG,eAAe,OAAnB,EAA4B,YAAY;AAC3C,kBAAE,KAAF;AACH,aAFM,CAAP;AAGH;;AAED,aAAK,IAAI,IAAI,CAAR,EAAW,IAAI,KAAK,MAAzB,EAAiC,IAAI,CAArC,EAAwC,GAAxC,EAA6C;AACzC,gBAAI,OAAO;AACP,sBAAM,KAAK,CAAL,CADC;AAEP,0BAAU,YAAY,OAAO;AAFtB,aAAX;;AAKA,gBAAI,aAAJ,EAAmB;AACf,kBAAE,MAAF,CAAS,OAAT,CAAiB,IAAjB;AACH,aAFD,MAEO;AACH,kBAAE,MAAF,CAAS,IAAT,CAAc,IAAd;AACH;AACJ;AACD,SAAC,GAAG,eAAe,OAAnB,EAA4B,EAAE,OAA9B;AACH;;AAED,aAAS,KAAT,CAAe,KAAf,EAAsB;AAClB,eAAO,CAAC,GAAG,OAAO,OAAX,EAAoB,UAAU,IAAV,EAAgB;AACvC,uBAAW,CAAX;;AAEA,iBAAK,IAAI,IAAI,CAAR,EAAW,IAAI,MAAM,MAA1B,EAAkC,IAAI,CAAtC,EAAyC,GAAzC,EAA8C;AAC1C,oBAAI,OAAO,MAAM,CAAN,CAAX;AACA,oBAAI,QAAQ,CAAC,GAAG,cAAc,OAAlB,EAA2B,WAA3B,EAAwC,IAAxC,EAA8C,CAA9C,CAAZ;AACA,oBAAI,SAAS,CAAb,EAAgB;AACZ,gCAAY,MAAZ,CAAmB,KAAnB;AACH;;AAED,qBAAK,QAAL,CAAc,KAAd,CAAoB,IAApB,EAA0B,IAA1B;;AAEA,oBAAI,KAAK,CAAL,KAAW,IAAf,EAAqB;AACjB,sBAAE,KAAF,CAAQ,KAAK,CAAL,CAAR,EAAiB,KAAK,IAAtB;AACH;AACJ;;AAED,gBAAI,WAAW,EAAE,WAAF,GAAgB,EAAE,MAAjC,EAAyC;AACrC,kBAAE,WAAF;AACH;;AAED,gBAAI,EAAE,IAAF,EAAJ,EAAc;AACV,kBAAE,KAAF;AACH;AACD,cAAE,OAAF;AACH,SAzBM,CAAP;AA0BH;;AAED,QAAI,UAAU,CAAd;AACA,QAAI,cAAc,EAAlB;AACA,QAAI,IAAI;AACJ,gBAAQ,IAAI,mBAAmB,OAAvB,EADJ;AAEJ,qBAAa,WAFT;AAGJ,iBAAS,OAHL;AAIJ,mBAAW,OAAO,OAJd;AAKJ,qBAAa,OAAO,OALhB;AAMJ,gBAAQ,cAAc,CANlB;AAOJ,eAAO,OAAO,OAPV;AAQJ,eAAO,OAAO,OARV;AASJ,eAAO,OAAO,OATV;AAUJ,iBAAS,KAVL;AAWJ,gBAAQ,KAXJ;AAYJ,cAAM,UAAU,IAAV,EAAgB,QAAhB,EAA0B;AAC5B,oBAAQ,IAAR,EAAc,KAAd,EAAqB,QAArB;AACH,SAdG;AAeJ,cAAM,YAAY;AACd,cAAE,KAAF,GAAU,OAAO,OAAjB;AACA,cAAE,MAAF,CAAS,KAAT;AACH,SAlBG;AAmBJ,iBAAS,UAAU,IAAV,EAAgB,QAAhB,EAA0B;AAC/B,oBAAQ,IAAR,EAAc,IAAd,EAAoB,QAApB;AACH,SArBG;AAsBJ,iBAAS,YAAY;AACjB,mBAAO,CAAC,EAAE,MAAH,IAAa,UAAU,EAAE,WAAzB,IAAwC,EAAE,MAAF,CAAS,MAAxD,EAAgE;AAC5D,oBAAI,QAAQ,EAAZ;AAAA,oBACI,OAAO,EADX;AAEA,oBAAI,IAAI,EAAE,MAAF,CAAS,MAAjB;AACA,oBAAI,EAAE,OAAN,EAAe,IAAI,KAAK,GAAL,CAAS,CAAT,EAAY,EAAE,OAAd,CAAJ;AACf,qBAAK,IAAI,IAAI,CAAb,EAAgB,IAAI,CAApB,EAAuB,GAAvB,EAA4B;AACxB,wBAAI,OAAO,EAAE,MAAF,CAAS,KAAT,EAAX;AACA,0BAAM,IAAN,CAAW,IAAX;AACA,yBAAK,IAAL,CAAU,KAAK,IAAf;AACH;;AAED,oBAAI,EAAE,MAAF,CAAS,MAAT,KAAoB,CAAxB,EAA2B;AACvB,sBAAE,KAAF;AACH;AACD,2BAAW,CAAX;AACA,4BAAY,IAAZ,CAAiB,MAAM,CAAN,CAAjB;;AAEA,oBAAI,YAAY,EAAE,WAAlB,EAA+B;AAC3B,sBAAE,SAAF;AACH;;AAED,oBAAI,KAAK,CAAC,GAAG,WAAW,OAAf,EAAwB,MAAM,KAAN,CAAxB,CAAT;AACA,uBAAO,IAAP,EAAa,EAAb;AACH;AACJ,SA/CG;AAgDJ,gBAAQ,YAAY;AAChB,mBAAO,EAAE,MAAF,CAAS,MAAhB;AACH,SAlDG;AAmDJ,iBAAS,YAAY;AACjB,mBAAO,OAAP;AACH,SArDG;AAsDJ,qBAAa,YAAY;AACrB,mBAAO,WAAP;AACH,SAxDG;AAyDJ,cAAM,YAAY;AACd,mBAAO,EAAE,MAAF,CAAS,MAAT,GAAkB,OAAlB,KAA8B,CAArC;AACH,SA3DG;AA4DJ,eAAO,YAAY;AACf,cAAE,MAAF,GAAW,IAAX;AACH,SA9DG;AA+DJ,gBAAQ,YAAY;AAChB,gBAAI,EAAE,MAAF,KAAa,KAAjB,EAAwB;AACpB;AACH;AACD,cAAE,MAAF,GAAW,KAAX;AACA,gBAAI,cAAc,KAAK,GAAL,CAAS,EAAE,WAAX,EAAwB,EAAE,MAAF,CAAS,MAAjC,CAAlB;AACA;AACA;AACA,iBAAK,IAAI,IAAI,CAAb,EAAgB,KAAK,WAArB,EAAkC,GAAlC,EAAuC;AACnC,iBAAC,GAAG,eAAe,OAAnB,EAA4B,EAAE,OAA9B;AACH;AACJ;AA1EG,KAAR;AA4EA,WAAO,CAAP;AACH;AACD,OAAO,OAAP,GAAiB,QAAQ,SAAR,CAAjB","file":"queue-compiled.js","sourcesContent":["'use strict';\n\nObject.defineProperty(exports, \"__esModule\", {\n    value: true\n});\nexports.default = queue;\n\nvar _baseIndexOf = require('lodash/_baseIndexOf');\n\nvar _baseIndexOf2 = _interopRequireDefault(_baseIndexOf);\n\nvar _isArray = require('lodash/isArray');\n\nvar _isArray2 = _interopRequireDefault(_isArray);\n\nvar _noop = require('lodash/noop');\n\nvar _noop2 = _interopRequireDefault(_noop);\n\nvar _rest = require('./rest');\n\nvar _rest2 = _interopRequireDefault(_rest);\n\nvar _onlyOnce = require('./onlyOnce');\n\nvar _onlyOnce2 = _interopRequireDefault(_onlyOnce);\n\nvar _setImmediate = require('./setImmediate');\n\nvar _setImmediate2 = _interopRequireDefault(_setImmediate);\n\nvar _DoublyLinkedList = require('./DoublyLinkedList');\n\nvar _DoublyLinkedList2 = _interopRequireDefault(_DoublyLinkedList);\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }\n\nfunction queue(worker, concurrency, payload) {\n    if (concurrency == null) {\n        concurrency = 1;\n    } else if (concurrency === 0) {\n        throw new Error('Concurrency must not be zero');\n    }\n\n    function _insert(data, insertAtFront, callback) {\n        if (callback != null && typeof callback !== 'function') {\n            throw new Error('task callback must be a function');\n        }\n        q.started = true;\n        if (!(0, _isArray2.default)(data)) {\n            data = [data];\n        }\n        if (data.length === 0 && q.idle()) {\n            // call drain immediately if there are no tasks\n            return (0, _setImmediate2.default)(function () {\n                q.drain();\n            });\n        }\n\n        for (var i = 0, l = data.length; i < l; i++) {\n            var item = {\n                data: data[i],\n                callback: callback || _noop2.default\n            };\n\n            if (insertAtFront) {\n                q._tasks.unshift(item);\n            } else {\n                q._tasks.push(item);\n            }\n        }\n        (0, _setImmediate2.default)(q.process);\n    }\n\n    function _next(tasks) {\n        return (0, _rest2.default)(function (args) {\n            workers -= 1;\n\n            for (var i = 0, l = tasks.length; i < l; i++) {\n                var task = tasks[i];\n                var index = (0, _baseIndexOf2.default)(workersList, task, 0);\n                if (index >= 0) {\n                    workersList.splice(index);\n                }\n\n                task.callback.apply(task, args);\n\n                if (args[0] != null) {\n                    q.error(args[0], task.data);\n                }\n            }\n\n            if (workers <= q.concurrency - q.buffer) {\n                q.unsaturated();\n            }\n\n            if (q.idle()) {\n                q.drain();\n            }\n            q.process();\n        });\n    }\n\n    var workers = 0;\n    var workersList = [];\n    var q = {\n        _tasks: new _DoublyLinkedList2.default(),\n        concurrency: concurrency,\n        payload: payload,\n        saturated: _noop2.default,\n        unsaturated: _noop2.default,\n        buffer: concurrency / 4,\n        empty: _noop2.default,\n        drain: _noop2.default,\n        error: _noop2.default,\n        started: false,\n        paused: false,\n        push: function (data, callback) {\n            _insert(data, false, callback);\n        },\n        kill: function () {\n            q.drain = _noop2.default;\n            q._tasks.empty();\n        },\n        unshift: function (data, callback) {\n            _insert(data, true, callback);\n        },\n        process: function () {\n            while (!q.paused && workers < q.concurrency && q._tasks.length) {\n                var tasks = [],\n                    data = [];\n                var l = q._tasks.length;\n                if (q.payload) l = Math.min(l, q.payload);\n                for (var i = 0; i < l; i++) {\n                    var node = q._tasks.shift();\n                    tasks.push(node);\n                    data.push(node.data);\n                }\n\n                if (q._tasks.length === 0) {\n                    q.empty();\n                }\n                workers += 1;\n                workersList.push(tasks[0]);\n\n                if (workers === q.concurrency) {\n                    q.saturated();\n                }\n\n                var cb = (0, _onlyOnce2.default)(_next(tasks));\n                worker(data, cb);\n            }\n        },\n        length: function () {\n            return q._tasks.length;\n        },\n        running: function () {\n            return workers;\n        },\n        workersList: function () {\n            return workersList;\n        },\n        idle: function () {\n            return q._tasks.length + workers === 0;\n        },\n        pause: function () {\n            q.paused = true;\n        },\n        resume: function () {\n            if (q.paused === false) {\n                return;\n            }\n            q.paused = false;\n            var resumeCount = Math.min(q.concurrency, q._tasks.length);\n            // Need to call q.process once per concurrent\n            // worker to preserve full concurrency after pause\n            for (var w = 1; w <= resumeCount; w++) {\n                (0, _setImmediate2.default)(q.process);\n            }\n        }\n    };\n    return q;\n}\nmodule.exports = exports['default'];"]}